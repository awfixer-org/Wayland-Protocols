<?xml version="1.0" encoding="UTF-8"?>
<protocol name="input_method_v3">
  <copyright>
    Copyright © 2008-2011 Kristian Høgsberg
    Copyright © 2010-2011 Intel Corporation
    Copyright © 2012-2013 Collabora, Ltd.
    Copyright © 2012, 2013 Intel Corporation
    Copyright © 2015, 2016 Jan Arne Petersen
    Copyright © 2017, 2018 Red Hat, Inc.
    Copyright © 2018, 2021 Purism SPC
    Copyright © 2021, 2024 Simon Ser
    Copyright © 2024       Eivind Gamst

    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
    to deal in the Software without restriction, including without limitation
    the rights to use, copy, modify, merge, publish, distribute, sublicense,
    and/or sell copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice (including the next
    paragraph) shall be included in all copies or substantial portions of the
    Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
    THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
    DEALINGS IN THE SOFTWARE.
  </copyright>

  <description summary="Protocol for creating input methods">
    This protocol allows applications to act as input methods for compositors.

    An input method context is used to manage the state of the input method.

    Text strings are UTF-8 encoded, their indices and lengths are in bytes.

    This document adheres to the RFC 2119 when using words like "must",
    "should", "may", etc.
  </description>

  <interface name="wp_input_method_v3" version="1">
    <description summary="input method">
      An input method object allows for clients to compose text.

      The objects connects the client to a text input in an application, and
      lets the client to serve as an input method for a seat.

      The wp_input_method_v3 object can occupy two distinct states: active and
      inactive. In the active state, the object is associated to and
      communicates with a text input. In the inactive state, there is no
      associated text input, and the only communication is with the compositor.
      Initially, the input method is in the inactive state.

      Requests issued in the inactive state must be accepted by the compositor.
      Because of the serial mechanism, and the state reset on activate event,
      they will not have any effect on the state of the next text input.
    </description>

    <request name="destroy" type="destructor">
      <description summary="destroy the input method">
        Destroys the wp_input_method_v3 object and any associated child
        objects, i.e. wp_input_popup_surface_v3
      </description>
    </request>

    <event name="activate">
      <description summary="input method has been requested">
        Notification that a text input focused on this seat requested the input
        method to be activated.

        This event serves the purpose of providing the compositor with an
        active input method.

        This event resets all state associated with previous enable, disable,
        surrounding_text, text_change_cause, and content_type events, as well
        as the state associated with set_preedit_string, commit_string, and
        delete_surrounding_text requests. In addition, it marks the
        wp_input_method_v3 object as active.

        The surrounding_text, and content_type events must follow before the
        next done event if the text input supports the respective
        functionality.

        State set with this event is double-buffered. It will get applied on
        the next wp_input_method_v3.done event, and stay valid until changed.

        The app ID identifies the general class of applications to which
        the current input method context belongs. An input method framework
        can use this to manage individual state for different text input
        clients.

        For D-Bus activatable applications, the app ID is used as the D-Bus
        service name.

        The compositor shell will try to group application surfaces together
        by their app ID. As a best practice, it is suggested to select app
        ID's that match the basename of the application's .desktop file.
        For example, "org.freedesktop.FooViewer" where the .desktop file is
        "org.freedesktop.FooViewer.desktop".

        See the desktop-entry specification [0] for more details on
        application identifiers and how they relate to well-known D-Bus
        names and .desktop files.

        [0] http://standards.freedesktop.org/desktop-entry-spec/
      </description>
      <arg name="app_id" type="string"/>
    </event>

    <event name="deactivate">
      <description summary="deactivate event">
        Notification that no focused text input currently needs an active
        input method on this seat.

        This event marks the wp_input_method_v3 object as inactive. The
        compositor must make all existing wp_input_popup_surface_v3 objects
        invisible until the next activate event.

        State set with this event is double-buffered. It will get applied on
        the next wp_input_method_v3.done event, and stay valid until changed.
      </description>
    </event>

    <event name="text_input_destroyed">
      <description summary="text input has been destroyed">
        Notification that a text input focused on this seat has been destroyed.

        This event serves the purpose of providing the input method with 
        information of when and which text input has been destroyed.

        This event removed all state associated with a text input.

        The app ID identifies the general class of applications to which
        the current input method context belongs. An input method framework
        can use this to manage individual state for different text input
        clients.

        For D-Bus activatable applications, the app ID is used as the D-Bus
        service name.

        The compositor shell will try to group application surfaces together
        by their app ID. As a best practice, it is suggested to select app
        ID's that match the basename of the application's .desktop file.
        For example, "org.freedesktop.FooViewer" where the .desktop file is
        "org.freedesktop.FooViewer.desktop".

        See the desktop-entry specification [0] for more details on
        application identifiers and how they relate to well-known D-Bus
        names and .desktop files.

        [0] http://standards.freedesktop.org/desktop-entry-spec/
      </description>
      <arg name="app_id" type="string"/>
    </event>

    <event name="surrounding_text">
      <description summary="surrounding text event">
        Updates the surrounding plain text around the cursor, excluding the
        preedit text.

        If any preedit text is present, it is replaced with the cursor for the
        purpose of this event.

        The argument text is a buffer containing the preedit string, and must
        include the cursor position, and the complete selection. It should
        contain additional characters before and after these. There is a
        maximum length of wayland messages, so text can not be longer than 4000
        bytes.

        cursor is the byte offset of the cursor within the text buffer.

        anchor is the byte offset of the selection anchor within the text
        buffer. If there is no selected text, anchor must be the same as
        cursor.

        If this event does not arrive before the first done event, the input
        method may assume that the text input does not support this
        functionality and ignore following surrounding_text events.

        Values set with this event are double-buffered. They will get applied
        and set to initial values on the next wp_input_method_v3.done
        event.

        The initial state for affected fields is empty, meaning that the text
        input does not support sending surrounding text. If the empty values
        get applied, subsequent attempts to change them may have no effect.
      </description>
      <arg name="text" type="string"/>
      <arg name="cursor" type="uint"/>
      <arg name="anchor" type="uint"/>
    </event>

    <event name="text_change_cause">
      <description summary="indicates the cause of surrounding text change">
        Tells the input method why the text surrounding the cursor changed.

        Whenever the client detects an external change in text, cursor, or
        anchor position, it must issue this request to the compositor. This
        request is intended to give the input method a chance to update the
        preedit text in an appropriate way, e.g. by removing it when the user
        starts typing with a keyboard.

        cause describes the source of the change.

        The value set with this event is double-buffered. It will get applied
        and set to its initial value on the next wp_input_method_v3.done
        event.

        The initial value of cause is input_method.
      </description>
      <arg name="cause" type="uint" enum="wp_text_input_v3.change_cause"/>
    </event>

    <event name="content_type">
      <description summary="content purpose and hint">
        Indicates the content type and hint for the current
        wp_input_method_v3 instance.

        Values set with this event are double-buffered. They will get applied
        on the next wp_input_method_v3.done event.

        The initial value for hint is none, and the initial value for purpose
        is normal.
      </description>
      <arg name="hint" type="uint" enum="wp_text_input_v3.content_hint"/>
      <arg name="purpose" type="uint" enum="wp_text_input_v3.content_purpose"/>
    </event>

    <request name="commit">
      <description summary="apply state">
        Apply state changes from commit_string, set_preedit_string and
        delete_surrounding_text requests.

        The state relating to these events is double-buffered, and each one
        modifies the pending state. This request replaces the current state
        with the pending state.

        The connected text input is expected to proceed by evaluating the
        changes in the following order:

        1. Replace existing preedit string with the cursor.
        2. Delete requested surrounding text.
        3. Insert commit string with the cursor at its end.
        4. Calculate surrounding text to send.
        5. Insert new preedit text in cursor position.
        6. Place cursor inside preedit text.

        The serial number reflects the last state of the wp_input_method_v3
        object known to the client. The value of the serial argument must be
        equal to the number of done events already issued by that object. When
        the compositor receives a commit request with a serial different than
        the number of past done events, it must proceed as normal, except it
        should not change the current state of the wp_input_method_v3 object.
      </description>
      <arg name="serial" type="uint"/>
    </request>

    <event name="done">
      <description summary="apply state">
        Atomically applies state changes recently sent to the client.

        The done event establishes and updates the state of the client, and
        must be issued after any changes to apply them.

        Text input state (content purpose, content hint, surrounding text, and
        change cause) is conceptually double-buffered within an input method
        context.

        Events modify the pending state, as opposed to the current state in use
        by the input method. A done event atomically applies all pending state,
        replacing the current state. After done, the new pending state is as
        documented for each related request.

        Events must be applied in the order of arrival.

        Neither current nor pending state are modified unless noted otherwise.
      </description>
    </event>

    <request name="set_preedit_string">
      <description summary="pre-edit string">
        Send the pre-edit string text to the application text input.

        Place a new composing text (pre-edit) at the current cursor position.
        Any previously set composing text must be removed. Any previously
        existing selected text must be removed. The cursor is moved to a new
        position within the preedit string.

        The argument text is a buffer containing the preedit string. There is
        a maximum length of wayland messages, so text can not be longer than
        4000 bytes.

        The arguments cursor_begin and cursor_end are counted in bytes relative
        to the beginning of the submitted string buffer. Cursor should be
        hidden by the text input when both are equal to -1.

        cursor_begin indicates the beginning of the cursor. cursor_end
        indicates the end of the cursor. It may be equal or different than
        cursor_begin.

        Values set with this event are double-buffered. They must be applied on
        the next wp_input_method_v3.commit event.

        The initial value of text is an empty string. The initial value of
        cursor_begin, and cursor_end are both 0.
      </description>
      <arg name="text" type="string"/>
      <arg name="cursor_begin" type="int"/>
      <arg name="cursor_end" type="int"/>
    </request>

    <request name="set_string">
      <description summary="set string to be committed">
        Send the string text for insertion to the application.

        Inserts a string at current cursor position (see commit event
        sequence). The string to commit could be either just a single character
        after a key press or the result of some composing.

        The argument text is a buffer containing the string to insert. There is
        a maximum length of wayland messages, so text can not be longer than
        4000 bytes.

        Values set with this event are double-buffered. They must be applied
        and reset to initial on the next wp_text_input_v3.commit request.

        The initial value of text is an empty string.
      </description>
      <arg name="text" type="string"/>
    </request>

    <request name="delete_surrounding_text">
      <description summary="delete text">
        Remove the surrounding text.

        before_length and after_length are the number of bytes before and after
        the current cursor index (excluding the preedit text) to delete.

        If any preedit text is present, it is replaced with the cursor for the
        purpose of this event. In effect before_length is counted from the
        beginning of preedit text, and after_length from its end (see commit
        event sequence).

        Values set with this event are double-buffered. They must be applied
        and reset to initial on the next wp_input_method_v3.commit request.

        The initial values of both before_length and after_length are 0.
      </description>
      <arg name="before_length" type="uint"/>
      <arg name="after_length" type="uint"/>
    </request>

    <event name="keymap">
      <description summary="keyboard mapping">
        This event provides a file descriptor to the client which can be
        memory-mapped to provide a keyboard mapping description.
      </description>
      <arg name="format" type="uint" enum="wl_keyboard.keymap_format"
        summary="keymap format"/>
      <arg name="fd" type="fd" summary="keymap file descriptor"/>
      <arg name="size" type="uint" summary="keymap size, in bytes"/>
    </event>

    <event name="repeat_info">
      <description summary="repeat rate and delay">
        Informs the client about the keyboard's repeat rate and delay.

        This event is sent as soon as the wp_input_method_v3
        object has been created, and is guaranteed to be received by the
        client before any key press event.

        Negative values for either rate or delay are illegal. A rate of zero
        will disable any repeating (regardless of the value of delay).

        This event can be sent later on as well with a new value if necessary,
        so clients should continue listening for the event past the creation
        of wp_input_method_v3.
      </description>
      <arg name="rate" type="int"
	   summary="the rate of repeating keys in characters per second"/>
      <arg name="delay" type="int"
	   summary="delay in milliseconds since key down until repeating starts"/>
    </event>

    <enum name="error" summary="protocol errors">
      <entry name="invalid_serial" value="1" summary="invalid serial passed to pass_through"/>
    </enum>

    <event name="key">
      <description summary="key event">
        A key was pressed or released, forwarded from text input client.
        The time argument is a timestamp with millisecond granularity, with an
        undefined base.
      </description>
      <arg name="serial" type="uint" summary="serial number of the key event"/>
      <arg name="time" type="uint" summary="timestamp with millisecond granularity"/>
      <arg name="key" type="uint" summary="key that produced the event"/>
      <arg name="state" type="uint" enum="wl_keyboard.key_state"
        summary="physical state of the key"/>
    </event>

    <event name="modifiers">
      <description summary="modifier and group state">
        Notifies input method that the modifier and/or group state has changed,
        and it should update its local state. Forwarded from text-input.
      </description>
      <arg name="serial" type="uint" summary="serial number of the modifiers event"/>
      <arg name="mods_depressed" type="uint" summary="depressed modifiers"/>
      <arg name="mods_latched" type="uint" summary="latched modifiers"/>
      <arg name="mods_locked" type="uint" summary="locked modifiers"/>
      <arg name="group" type="uint" summary="keyboard layout"/>
    </event>

    <event name="available_actions">
      <description summary="notification of available actions">
        This event indicates which actions are supported by the text input.

        Values set with this event are double-buffered. They will get applied
        on the next wp_input_method_v3.done event.

        Initially, no actions are available.
      </description>
      <arg name="available_actions" type="array" summary="available actions"/>
    </event>

    <request name="set_action">
      <description summary="perform an action">
        Set the action to be performed on commit.

        Values set with this event are double-buffered. They must be applied
        and reset to initial on the next wp_input_method_v3.commit request.
      </description>
      <arg name="action" type="uint" enum="wp_text_input_v3.action" summary="action performed"/>
    </request>

    <request name="set_language">
      <description summary="notify of language selection">
        Notify the application of language used by the input method.

        This event will be sent on creation if known and for all subsequent changes.

        The language should be specified as an IETF BCP 47 tag.
        Setting an empty string will reset any known language back to the default unknown state.
      </description>
      <arg name="language" type="string" summary="new language set by IME"/>
    </request>

    <request name="set_preedit_commit_mode">
      <description summary="pre-edit commit mode">
        Specify how the visible preedit should be handled
        when switching the focus widget or changing the cursor position,
        whether to commit the preedit text or clear the preedit text.

        This is usually used together with the preedit_string event.

        The commit behavior is the same for focus switch and
        cursor position change.

        The parameter mode selects the desired behavior and
        its value is one from the commit mode enum.
      </description>
      <arg name="mode" type="uint" enum="wp_text_input_v3.commit_mode"/>
    </request>

    <request name="set_preedit_style">
      <description summary="pre-edit style">
        Sets styling information on composing text.
        Event sent without preedit string sets a default style for all future
        preedit text.

        The parameters begin and end are counted in bytes relative to the
        beginning of the text buffer submitted through
        wp_text_input_v3.preedit_string.

        Multiple events may be submitted if the preedit string has different
        sections. Compositors/input method must not send multiple
        wp_text_input_v3.preedit_underline events with overlapping extents.

        Clients should pick colors appropriate for their color scheme,
        underline colors follows text color. For parts of the preedit string
        that are not covered by any wp_text_input_v3.preedit_hint event,
        or if no events were sent, the text will be considered unstyled.

        Values set with this event are double-buffered. They must be applied
        and reset on the next wp_text_input_v3.done event.
      </description>
      <arg name="begin" type="int"/>
      <arg name="end" type="int"/>
      <arg name="underline" type="int" enum="wp_text_input_v3.preedit_underline"/>
      <arg name="style" type="int" enum="wp_text_input_v3.preedit_style"/>
      <arg name="color" type="int" enum="wp_text_input_v3.preedit_color_hint"/>
    </request>

    <request name="get_input_method_popup">
      <description summary="tell the compositor to assign parents to this xdg_popup">
        This tells the compositor to assign parents to an xdg_popup.
        This popup should have been created via xdg_surface::get_popup
        with the parent set to NULL, and this request must be invoked
        before committing the popup's initial state.

        See the documentation of xdg_popup for more details about what an
        xdg_popup is and how it is used.
      </description>
      <arg name="popup" type="object" interface="xdg_popup"/>
    </request>

    <event name="cursor_rectangle">
      <description summary="set cursor position">
        Marks an area around the cursor as a x, y, width, height rectangle in
        surface local coordinates.

        Allows the compositor to put a window with word suggestions near the
        cursor, without obstructing the text being input.

        If the client is unaware of the position of edited text, it should not
        issue this request, to signify lack of support to the compositor.

        Values set with this request are double-buffered. They will get applied
        on the next wp_text_input_v3.commit request, and stay valid until the
        next committed enable or disable request.

        The initial values describing a cursor rectangle are empty. That means
        the text input does not support describing the cursor area. If the
        empty values get applied, subsequent attempts to change them may have
        no effect.

        As of version 2, the values sent with this request are not used
        immediately after they are applied to the text-input state.

        After the pending state is applied with the wp_text_input_v3.commit
        request, the following wl_surface.commit request on the surface with
        text-input focus will cause the values to become active.

        If the surface with text-input focus changes before a wl_surface.commit
        request is sent, the values are discarded.
      </description>
      <arg name="x" type="int"/>
      <arg name="y" type="int"/>
      <arg name="width" type="int"/>
      <arg name="height" type="int"/>
    </event>
  </interface>

  <interface name="wp_input_method_manager_v3" version="1">
    <description summary="input method manager">
      The input method manager allows the client to become an input method on
      a chosen seat.

      There can be several input methods running but only one method should be
      associated with one text input client.

      To avoid key logging this is a priviledged protocol.
    </description>

    <request name="get_input_method">
      <description summary="request an input method object">
        Request a new input wp_input_method_v3 object associated with a given
        seat.
      </description>
      <arg name="seat" type="object" interface="wl_seat"/>
      <arg name="input_method" type="new_id" interface="wp_input_method_v3"/>
      <arg name="app_id" type="string"/>
    </request>

    <request name="destroy" type="destructor">
      <description summary="destroy the input method manager">
        Destroys the wp_input_method_manager_v3 object.

        The wp_input_method_v3 objects originating from it remain valid.
      </description>
    </request>
  </interface>
</protocol>
